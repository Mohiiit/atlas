<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Module 04 - Perpetuals (Content-Rich)</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#fff4f4;--surface:#fff;--text:#3a0f14;--dim:#7c3a45;--border:#f1ced3;--accent:#b91c1c;--accent-dim:rgba(185,28,28,.11)}
@media (prefers-color-scheme: dark){:root{--bg:#170b0f;--surface:#261116;--text:#ffe5e8;--dim:#dba1aa;--border:#4d2029;--accent:#fb7185;--accent-dim:rgba(251,113,133,.14)}}
*{box-sizing:border-box}body{margin:0;font-family:'Chakra Petch',sans-serif;background:radial-gradient(circle at 15% 5%,var(--accent-dim),transparent 35%),var(--bg);color:var(--text);padding:28px}
main{max-width:1120px;margin:0 auto}h1{margin:0;font-size:35px}.sub{margin:8px 0 18px;color:var(--dim);font:12px 'IBM Plex Mono',monospace}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}@media(max-width:920px){.grid{grid-template-columns:1fr}}.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px}.k{display:block;font:11px 'IBM Plex Mono',monospace;text-transform:uppercase;color:var(--accent);margin-bottom:10px}
 p,li{line-height:1.62}p{color:var(--dim);margin:8px 0}ul,ol{margin:8px 0 0 18px;color:var(--dim)}li{margin:7px 0}code{font-family:'IBM Plex Mono',monospace;background:var(--accent-dim);color:var(--accent);padding:2px 6px;border-radius:4px}
 .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}.data{width:100%;border-collapse:collapse;font-size:13px}.data th,.data td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:top}.data th{background:var(--accent-dim);font:11px 'IBM Plex Mono',monospace;text-transform:uppercase;color:var(--accent);text-align:left}
</style>
</head>
<body>
<main>
  <h1>Module 04: Perps from First Principles</h1>
  <p class="sub">Content-rich explainer: margin loop, funding mechanism, liquidation dynamics, and protocol design comparisons</p>

  <section class="card">
    <span class="k">Why This Matters</span>
    <ul>
      <li>Perps are the dominant crypto derivatives venue; understanding them is mandatory for modern DeFi fluency.</li>
      <li>Most catastrophic failures are not from formula errors but from liquidation throughput, oracle latency, and insurance design.</li>
      <li>If you build infra, you will touch matching, risk checks, or settlement pipelines that assume perp mechanics.</li>
      <li>Funding, mark pricing, and ADL are where user trust is won or lost.</li>
    </ul>
  </section>

  <div class="grid">
    <section class="card">
      <span class="k">Mechanism Walkthrough</span>
      <pre class="mermaid">flowchart TD
        A[Open position + post collateral] --> B[Mark/index updates]
        B --> C[Unrealized PnL recalculation]
        C --> D[Equity and margin check]
        D -->|Healthy| E[Position continues]
        D -->|Breach| F[Liquidation trigger]
        F --> G[Partial or full close]
        G --> H[Insurance fund absorbs shortfall if needed]
        E --> I[Funding payment transfer]
        I --> B
      </pre>
      <p>Perp systems are continuous risk engines. Every mark update is effectively a solvency test. If equity falls below maintenance threshold, liquidation starts; if liquidation cannot fill quickly enough, insurance absorbs losses; if insurance is insufficient, ADL/socialized loss mechanisms may activate.</p>
      <p>The protocol is healthy only if this loop clears stress faster than volatility creates insolvency.</p>
    </section>

    <section class="card">
      <span class="k">First Principles</span>
      <ol>
        <li><strong>Perp is a synthetic forward:</strong> no expiry, so convergence is enforced by funding transfers.</li>
        <li><strong>Mark price governs solvency:</strong> PnL and liquidation rely on mark/index logic, not last traded print alone.</li>
        <li><strong>Leverage is convex risk:</strong> doubling leverage more than doubles liquidation sensitivity.</li>
        <li><strong>Insurance is finite:</strong> prolonged one-sided moves stress the backstop and test ADL policy.</li>
      </ol>
      <span class="k" style="margin-top:14px">Core Equations</span>
      <ul>
        <li><code>notional = size * mark</code></li>
        <li><code>uPnL_long = size * (mark - entry)</code></li>
        <li><code>equity = collateral + uPnL - fees - funding</code></li>
      </ul>
    </section>
  </div>

  <section class="card">
    <span class="k">Worked Examples</span>
    <p><strong>Example 1: 10x long liquidation path</strong><br>Long 1 BTC at 60,000 with 6,000 collateral. If mark drops to 57,000, uPnL = -3,000, equity = 3,000. If maintenance margin requirement is 3,500, account breaches and enters liquidation queue.</p>
    <p><strong>Example 2: funding drag in persistent premium</strong><br>If funding is +0.01% every 8h and your notional is 60,000, long pays 6 each interval. Over 30 intervals (~10 days), funding cost is 180, reducing equity even if price is unchanged.</p>
    <div class="table-wrap">
      <table class="data">
        <thead><tr><th>Leverage</th><th>Collateral</th><th>Price Move to Lose 50% Equity (approx)</th><th>Risk Comment</th></tr></thead>
        <tbody>
          <tr><td>5x</td><td>12,000</td><td>-10%</td><td>Moderate room for volatility</td></tr>
          <tr><td>10x</td><td>6,000</td><td>-5%</td><td>Fast liquidation risk</td></tr>
          <tr><td>20x</td><td>3,000</td><td>-2.5%</td><td>Micro-move sensitive, near-continuous risk</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <span class="k">Failure Modes</span>
    <ul>
      <li><strong>Oracle/mark divergence:</strong> stale or manipulable index causes unfair liquidations or delayed risk realization.</li>
      <li><strong>Liquidation queue congestion:</strong> risk engine detects breach but cannot close notional fast enough.</li>
      <li><strong>Insurance depletion:</strong> tail events exhaust fund, forcing ADL and socialized losses.</li>
      <li><strong>Funding manipulation:</strong> bad design allows strategic influence over premium and transfer direction.</li>
    </ul>
  </section>

  <section class="card">
    <span class="k">What To Monitor</span>
    <ul>
      <li>Open interest concentration by side and leverage bucket.</li>
      <li>Distance-to-liquidation distribution (how many accounts close to MM threshold).</li>
      <li>Insurance fund balance and drawdown velocity during shocks.</li>
      <li>Funding volatility and bias persistence.</li>
      <li>Liquidation success rate and average close latency.</li>
    </ul>
  </section>

  <section class="card">
    <span class="k">Further Reading Prompts</span>
    <ol>
      <li>How do different mark price formulas change liquidation fairness in thin markets?</li>
      <li>What ADL policy best balances solvency with user predictability?</li>
      <li>How do Hyperliquid, dYdX, and GMX differ in matching and risk ownership?</li>
      <li>Can onchain perps match CEX execution quality without trusted matching layers?</li>
    </ol>
  </section>
</main>
<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
const d=window.matchMedia('(prefers-color-scheme: dark)').matches;
mermaid.initialize({startOnLoad:true,theme:'base',themeVariables:{primaryColor:d?'#3a1a22':'#ffe8eb',primaryBorderColor:d?'#fb7185':'#b91c1c',primaryTextColor:d?'#ffe5e8':'#3a0f14',lineColor:d?'#fbc7cf':'#7c3a45',fontFamily:'Chakra Petch',fontSize:'15px'}});
</script>
</body>
</html>
