<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YapCode + GEPA System Map</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --font-body: 'Space Grotesk', system-ui, sans-serif;
    --font-mono: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    --bg: #edf7ff;
    --surface: #ffffff;
    --surface-2: #f5fbff;
    --border: rgba(5, 45, 90, 0.16);
    --border-strong: rgba(5, 45, 90, 0.28);
    --text: #0f2742;
    --text-dim: #486684;
    --accent: #0077b6;
    --accent-2: #2a9d8f;
    --accent-3: #e76f51;
    --accent-dim: rgba(0, 119, 182, 0.1);
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #081421;
      --surface: #102235;
      --surface-2: #112b44;
      --border: rgba(199, 223, 246, 0.14);
      --border-strong: rgba(199, 223, 246, 0.28);
      --text: #dcefff;
      --text-dim: #8ab4db;
      --accent: #50c4ff;
      --accent-2: #7ce2d7;
      --accent-3: #ff9f80;
      --accent-dim: rgba(80, 196, 255, 0.16);
    }
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font-body);
    color: var(--text);
    background:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px),
      radial-gradient(circle at 80% -10%, var(--accent-dim), transparent 48%),
      var(--bg);
    background-size: 24px 24px, 24px 24px, auto, auto;
    min-height: 100vh;
    padding: 36px;
  }

  .container {
    max-width: 1180px;
    margin: 0 auto;
    display: grid;
    gap: 18px;
  }

  h1 {
    font-size: clamp(28px, 3.8vw, 44px);
    letter-spacing: -0.03em;
    margin-bottom: 8px;
    text-wrap: balance;
  }

  .subtitle {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }

  .lead {
    max-width: 960px;
    line-height: 1.65;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
  }

  .chip {
    font-size: 11px;
    font-family: var(--font-mono);
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border-strong);
    background: var(--surface-2);
  }

  .card {
    background: color-mix(in srgb, var(--surface) 92%, transparent);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 12px 26px rgba(2, 20, 40, 0.08);
  }

  .card h2 {
    font-size: 18px;
    margin-bottom: 8px;
  }

  .card p {
    color: var(--text-dim);
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 12px;
  }

  .grid-2 {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 14px;
  }

  .mermaid-wrap {
    position: relative;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 34px 14px 14px;
    overflow: auto;
    min-width: 0;
  }

  .mermaid-wrap .mermaid {
    display: flex;
    justify-content: center;
    transform-origin: top center;
    transition: transform 0.2s ease;
  }

  .zoom-controls {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 10;
    display: flex;
    gap: 2px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface);
    padding: 2px;
  }

  .zoom-controls button {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-family: var(--font-mono);
    cursor: pointer;
    border-radius: 4px;
  }

  .zoom-controls button:hover {
    background: var(--accent-dim);
    color: var(--text);
  }

  .mermaid-wrap.is-zoomed { cursor: grab; }
  .mermaid-wrap.is-panning { cursor: grabbing; user-select: none; }

  .mermaid .nodeLabel {
    font-family: var(--font-body) !important;
    font-size: 15px !important;
  }

  .mermaid .edgeLabel {
    font-family: var(--font-mono) !important;
    font-size: 12px !important;
    color: var(--text-dim) !important;
  }

  .mermaid .edgeLabel rect {
    fill: var(--surface-2) !important;
    stroke: var(--border) !important;
  }

  .mermaid .node rect,
  .mermaid .node circle,
  .mermaid .node polygon,
  .mermaid .node path {
    stroke-width: 1.5px !important;
  }

  ul {
    list-style: none;
    display: grid;
    gap: 8px;
  }

  li {
    font-size: 13px;
    color: var(--text-dim);
    padding-left: 14px;
    position: relative;
  }

  li::before {
    content: "";
    position: absolute;
    left: 0;
    top: 8px;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
  }

  @media (max-width: 980px) {
    body { padding: 18px; }
    .grid-2 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <main class="container">
    <header class="card">
      <div class="subtitle">YapCode Research Visual â€¢ Updated 2026-02-20</div>
      <h1>YapCode + GEPA System Map</h1>
      <p class="lead">
        This map captures how YapCode can use GEPA-style optimization without blowing up runtime cost: optimize prompt policies offline,
        serve prompt versions online, and feed real failures back into nightly evaluator-driven improvement.
      </p>
      <div class="chips">
        <span class="chip">Offline prompt optimization</span>
        <span class="chip">Evaluator-first coding quality</span>
        <span class="chip">Cost and latency in the score</span>
        <span class="chip">Prompt registry + safe promotion</span>
      </div>
    </header>

    <section class="card">
      <h2>1) Production + Offline Learning Loop</h2>
      <p>Online path should be fast and deterministic. GEPA runs offline against curated tasks and evaluator signals, then promotes better prompt versions.</p>
      <div class="mermaid-wrap">
        <div class="zoom-controls">
          <button onclick="zoomDiagram(this, 1.2)" title="Zoom in">+</button>
          <button onclick="zoomDiagram(this, 0.8)" title="Zoom out">&minus;</button>
          <button onclick="resetZoom(this)" title="Reset zoom">&#8634;</button>
        </div>
        <pre class="mermaid">
graph LR
  U[User Task + Repo Context] --> C[Task Classifier]
  C --> R[Prompt Router]
  R --> P[(Prompt Template Registry)]
  P --> A[Coding Agent Run]
  A --> E[Evaluator Harness]
  E --> O[Outcome + Trace Store]
  O --> T[Failure Mining + Task Curation]
  T --> G[Offline GEPA Optimizer]
  G --> V[Prompt Validation on Holdout]
  V -->|promote only if better| P

  E -. diagnostics .-> G
  O -. latency and token stats .-> G

  classDef online fill:#d7efff,stroke:#0077b6,color:#0b2f4f
  classDef offline fill:#d5f7f1,stroke:#2a9d8f,color:#0a3c37
  classDef store fill:#ffe8e2,stroke:#e76f51,color:#5b261a

  class U,C,R,A,E online
  class G,V,T offline
  class P,O store
        </pre>
      </div>
    </section>

    <section class="grid-2">
      <article class="card">
        <h2>2) Competitive Moat Loop</h2>
        <p>The strongest edge is proprietary failures + evaluator quality, not generic optimizer code.</p>
        <div class="mermaid-wrap">
          <div class="zoom-controls">
            <button onclick="zoomDiagram(this, 1.2)" title="Zoom in">+</button>
            <button onclick="zoomDiagram(this, 0.8)" title="Zoom out">&minus;</button>
            <button onclick="resetZoom(this)" title="Reset zoom">&#8634;</button>
          </div>
          <pre class="mermaid">
flowchart TD
  F[Real User Failures] --> D[Sanitized Task Dataset]
  D --> H[Language-Specific Evaluator Packs]
  H --> N[Nightly Optimization Jobs]
  N --> S[Shadow + A/B Validation]
  S --> L[Production Prompt Lift]
  L --> F

  classDef moat fill:#d5f7f1,stroke:#2a9d8f,color:#0a3c37
  classDef eval fill:#d7efff,stroke:#0077b6,color:#0b2f4f
  classDef risk fill:#ffe8e2,stroke:#e76f51,color:#5b261a
  class F,D,N,S,L moat
  class H eval
          </pre>
        </div>
      </article>

      <article class="card">
        <h2>3) Operational Rules</h2>
        <ul>
          <li>Do not run iterative optimization per live user request.</li>
          <li>Keep user details as slots; optimize reusable templates.</li>
          <li>Penalize token cost and runtime directly in evaluator score.</li>
          <li>Use hard caps: metric calls, candidate proposals, wall-clock timeout.</li>
          <li>Require holdout win before prompt promotion.</li>
          <li>Track rollback-safe prompt versions per task family.</li>
        </ul>
      </article>
    </section>
  </main>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  import elkLayouts from 'https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk/dist/mermaid-layout-elk.esm.min.mjs';

  const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  mermaid.registerLayoutLoaders(elkLayouts);
  mermaid.initialize({
    startOnLoad: true,
    theme: 'base',
    look: 'classic',
    layout: 'elk',
    flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' },
    themeVariables: {
      background: isDark ? '#102235' : '#f5fbff',
      primaryColor: isDark ? '#143a5a' : '#d7efff',
      primaryTextColor: isDark ? '#dcefff' : '#0f2742',
      primaryBorderColor: isDark ? '#50c4ff' : '#0077b6',
      secondaryColor: isDark ? '#1e403c' : '#d5f7f1',
      secondaryTextColor: isDark ? '#dcefff' : '#0f2742',
      secondaryBorderColor: isDark ? '#7ce2d7' : '#2a9d8f',
      tertiaryColor: isDark ? '#4f2a22' : '#ffe8e2',
      tertiaryTextColor: isDark ? '#ffd7ca' : '#4b2a23',
      tertiaryBorderColor: isDark ? '#ff9f80' : '#e76f51',
      lineColor: isDark ? '#8ab4db' : '#486684',
      edgeLabelBackground: isDark ? '#112b44' : '#f5fbff',
      fontFamily: 'Space Grotesk, sans-serif',
      fontSize: '16px'
    }
  });
</script>
<script>
function setZoom(wrap, zoom) {
  const target = wrap.querySelector('.mermaid');
  target.style.transform = 'scale(' + zoom + ')';
  target.dataset.zoom = String(zoom);
  wrap.classList.toggle('is-zoomed', zoom > 1);
}

function zoomDiagram(btn, factor) {
  const wrap = btn.closest('.mermaid-wrap');
  const target = wrap.querySelector('.mermaid');
  const current = parseFloat(target.dataset.zoom || '1');
  const next = Math.min(5, Math.max(0.3, current * factor));
  setZoom(wrap, next);
}

function resetZoom(btn) {
  const wrap = btn.closest('.mermaid-wrap');
  setZoom(wrap, 1);
  wrap.scrollLeft = 0;
  wrap.scrollTop = 0;
}

document.querySelectorAll('.mermaid-wrap').forEach((wrap) => {
  const target = wrap.querySelector('.mermaid');

  wrap.addEventListener('wheel', (e) => {
    if (!(e.ctrlKey || e.metaKey)) return;
    e.preventDefault();
    const current = parseFloat(target.dataset.zoom || '1');
    const factor = e.deltaY > 0 ? 0.92 : 1.08;
    const next = Math.min(5, Math.max(0.3, current * factor));
    setZoom(wrap, next);
  }, { passive: false });

  let isDown = false;
  let sx = 0;
  let sy = 0;
  let sl = 0;
  let st = 0;

  wrap.addEventListener('mousedown', (e) => {
    if (e.target.closest('.zoom-controls')) return;
    if (parseFloat(target.dataset.zoom || '1') <= 1) return;
    isDown = true;
    wrap.classList.add('is-panning');
    sx = e.clientX;
    sy = e.clientY;
    sl = wrap.scrollLeft;
    st = wrap.scrollTop;
  });

  window.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    wrap.scrollLeft = sl - (e.clientX - sx);
    wrap.scrollTop = st - (e.clientY - sy);
  });

  window.addEventListener('mouseup', () => {
    isDown = false;
    wrap.classList.remove('is-panning');
  });
});
</script>
</body>
</html>
